# 🧠 Psychia - Asystent Terapii TSR

**Inteligentny asystent do terapii Solution-Focused Brief Therapy (TSR) z wykorzystaniem sztucznej inteligencji**

[![Python](https://img.shields.io/badge/Python-3.12+-blue.svg)](https://python.org)
[![Streamlit](https://img.shields.io/badge/Streamlit-1.39+-red.svg)](https://streamlit.io)

## 📋 Spis treści

- [🎯 O aplikacji](#-o-aplikacji)
- [✨ Funkcjonalności](#-funkcjonalności)
- [🚀 Instalacja](#-instalacja)
- [⚙️ Konfiguracja](#️-konfiguracja)
- [💻 Użycie](#-użycie)
- [🤖 Modele AI](#-modele-ai)
- [🧪 Testowanie modeli](#-testowanie-modeli)
- [🔧 Pliki konfiguracyjne](#-pliki-konfiguracyjne)

## 🎯 O aplikacji

Psychia to zaawansowany asystent terapeutyczny wykorzystujący **Solution-Focused Brief Therapy (TSR)** - metodę terapii skupioną na rozwiązaniach. Aplikacja oferuje:

- **Profesjonalną terapię TSR** prowadzoną przez AI
- **Dwuagentowy system** z terapeutą i supervisorem
- **Protokoły bezpieczeństwa** dla sytuacji kryzysowych
- **Obsługę różnych modeli AI** (OpenAI, Google Gemini)
- **Zaawansowane testowanie** jakości modeli

## ✨ Funkcjonalności

### 🎭 **Dwuagentowy System AI**
- **🩺 Terapeuta AI**: Prowadzi rozmowę według zasad TSR
- **👥 Supervisor AI**: Ocenia postępy i decyduje o przejściach między etapami
- **🧠 Inteligentna pamięć**: Optymalne zarządzanie kontekstem rozmowy

### 📋 **Etapy Terapii TSR - Szczegółowy Workflow**

#### **ETAP 1: 🤝 Otwarcie i określenie celu** (10-15 min)
**CO SIĘ DZIEJE:**
- Terapeuta AI ciepło wita użytkownika i nawiązuje kontakt
- Pomaga użytkownikowi sformułować konkretny cel sesji
- Upewnia się, że cel jest realistyczny i osiągalny

**PRZYKŁADOWE PYTANIA TERAPEUTY:**
- *"Czego chciałbyś dziś osiągnąć w naszej rozmowie?"*
- *"Co musiałoby się wydarzyć, żebyś wyszedł z tej sesji z poczuciem, że była pomocna?"*
- *"Jak wyglądałby dla Ciebie dobry efekt naszej dzisiejszej rozmowy?"*

**SUPERVISOR SPRAWDZA:**
- ✅ Czy nawiązano pozytywny kontakt?
- ✅ Czy użytkownik rozumie podejście TSR (skupienie na rozwiązaniach)?
- ✅ Czy cel jest jasno określony i pozytywny?

**PRZEJŚCIE DO ETAPU 2:** Gdy cel jest jasny, konkretny i użytkownik jest gotowy do pracy

---

#### **ETAP 2: 💎 Zasoby i wyjątki** (15-20 min)
**CO SIĘ DZIEJE:**
- Odkrywanie mocnych stron i umiejętności użytkownika
- Poszukiwanie "wyjątków" - sytuacji gdy problem nie występuje
- Wzmacnianie pozytywnych aspektów i sukcesów

**PRZYKŁADOWE PYTANIA TERAPEUTY:**
- *"Kiedy ostatnio ten problem był mniejszy lub w ogóle nie występował?"*
- *"Co robiłeś inaczej w tamtej sytuacji?"*
- *"Na co możesz liczyć w trudnych momentach?"*
- *"Jakie masz umiejętności, które pomagają Ci radzić sobie z wyzwaniami?"*
- *"Co Twoi bliscy powiedzieliby o Twoich mocnych stronach?"*

**SUPERVISOR SPRAWDZA:**
- ✅ Czy zidentyfikowano co najmniej 2-3 zasoby użytkownika?
- ✅ Czy odkryto wyjątki (sytuacje bez problemu)?
- ✅ Czy użytkownik dostrzega swoje mocne strony?

**PRZEJŚCIE DO ETAPU 3:** Gdy użytkownik rozpoznaje swoje zasoby i wyjątki

---

#### **ETAP 3: 📊 Skale** (10-15 min)
**CO SIĘ DZIEJE:**
- Wprowadzenie skali 1-10 do oceny aktualnej sytuacji
- Określenie obecnego poziomu i wizualizacja poprawy
- Znalezienie konkretnych oznak poprawy o jeden poziom wyżej

**PRZYKŁADOWE PYTANIA TERAPEUTY:**
- *"Na skali od 1 do 10, gdzie 1 to najgorszy stan, a 10 to idealne rozwiązanie, gdzie jesteś teraz?"*
- *"Co sprawiłoby, że poszedłbyś z [obecny poziom] na [poziom +1]?"*
- *"Jakie małe oznaki wskazywałyby, że sytuacja się poprawia?"*
- *"Co zauważyliby inni, gdybyś był o jeden poziom wyżej?"*

**SUPERVISOR SPRAWDZA:**
- ✅ Czy ustalono skalę 1-10 dla aktualnej sytuacji?
- ✅ Czy użytkownik potrafi opisać różnicę między poziomami?
- ✅ Czy zidentyfikowano oznaki poprawy o jeden poziom wyżej?

**PRZEJŚCIE DO ETAPU 4:** Gdy użytkownik rozumie skalę i wie, jak wyglądałaby poprawa

---

#### **ETAP 4: 👣 Małe kroki i działania** (15-20 min)
**CO SIĘ DZIEJE:**
- Planowanie konkretnych, małych kroków do osiągnięcia celu
- Upewnienie się, że działania są realistyczne i wykonalne
- Wzmacnianie motywacji do działania

**PRZYKŁADOWE PYTANIA TERAPEUTY:**
- *"Jaki najmniejszy krok mógłbyś podjąć już dziś?"*
- *"Co z rzeczy, które już robisz, mogłbyś robić trochę częściej?"*
- *"Gdybyś miał zrobić coś małego jutro, co by to było?"*
- *"Na ile jesteś pewien, że wykonasz ten krok? (skala 1-10)"*

**ZASADY MAŁYCH KROKÓW:**
- Im mniejszy krok, tym większa szansa na sukces
- Lepiej jeden mały krok niż duży plan
- Wykorzystywanie istniejących nawyków i rutyn

**SUPERVISOR SPRAWDZA:**
- ✅ Czy zaplanowano co najmniej 1-2 konkretne małe kroki?
- ✅ Czy działania są realistyczne i wykonalne?
- ✅ Czy użytkownik wyraża gotowość do podjęcia działań?

**PRZEJŚCIE DO ETAPU 5:** Gdy mamy konkretny, realistyczny plan działania

---

#### **ETAP 5: 🎊 Podsumowanie i wzmocnienie** (10-15 min)
**CO SIĘ DZIEJE:**
- Podsumowanie kluczowych ustaleń z całej sesji
- Wzmocnienie odkrytych zasobów i mocnych stron
- Wyrażenie wiary w możliwości użytkownika
- Pozytywne zakończenie sesji

**ELEMENTY PODSUMOWANIA:**
1. Cel sesji i czy został osiągnięty
2. Odkryte zasoby i mocne strony
3. Ważne wyjątki i sukcesy
4. Ustalone małe kroki do działania
5. Pozytywne wzmocnienie

**PRZYKŁADOWE SFORMUŁOWANIA TERAPEUTY:**
- *"Widzę, że udało nam się..."*
- *"Jestem pod wrażeniem Twoich..."*
- *"Zauważyłem, że masz umiejętność..."*
- *"Wierzę, że jesteś w stanie..."*

**SUPERVISOR SPRAWDZA:**
- ✅ Czy sesja została podsumowana z kluczowymi ustaleniami?
- ✅ Czy wzmocniono zasoby i plan działania?
- ✅ Czy użytkownik czuje się zmotywowany i ma jasny plan?

**ZAKOŃCZENIE:** Sesja kończy się, gdy użytkownik ma jasny plan i czuje się zmotywowany

---

## 🔧 **Workflow Programowy - Jak Działa System**

### **📋 Ogólny przepływ danych:**
```
1. 👤 User Input →
2. 🎭 TherapyWorkflowManager →
3. 🔍 SupervisorEvaluator →
4. 🩺 TherapistResponder →
5. 🤖 BaseAgent →
6. 💬 LLM Provider →
7. 📝 Response + Logs
```

### **🔄 Szczegółowy workflow dla każdej wiadomości:**

#### **Krok 1: 📥 Przetwarzanie Input'u**
```python
# app.py → therapy_page()
user_message = st.chat_input("Napisz wiadomość...")

# Przekazanie do workflow managera
workflow_manager = TherapyWorkflowManager(
    agent_provider=agent_provider,
    session_manager=session_manager,
    prompt_manager=prompt_manager,
    logger=technical_logger
)
```

#### **Krok 2: 🔍 Ocena Supervisora (przed odpowiedzią)**
```python
# workflow/supervisor_evaluator.py
def evaluate_stage_completion():
    # 1. Pobieranie system prompt dla supervisora
    system_prompt = prompt_manager.get_system_prompt("supervisor")
    supervisor_agent.set_system_prompt(system_prompt)  # RAZ NA SESJĘ

    # 2. Pobieranie stage prompt dla aktualnego etapu
    stage_prompt = prompt_manager.get_stage_prompt(current_stage, "supervisor")
    supervisor_agent.set_stage_prompt(current_stage, stage_prompt)  # RAZ NA ETAP

    # 3. Generowanie oceny z kontekstem rozmowy
    evaluation = supervisor_agent.evaluate_stage_completion(
        stage=current_stage,
        history=conversation_history,
        stage_prompt=stage_prompt
    )

    return SupervisorDecision(decision="advance|stay", reason="...", ...)
```

#### **Krok 3: 🎯 Zmiana Etapu (jeśli supervisor zdecydował)**
```python
# therapy_workflow_manager.py
if supervisor_decision.decision == "advance":
    # Przejście do następnego etapu
    session_manager.advance_stage()
    current_stage = session_manager.get_current_stage()

    # LOG: Zmiana etapu
    logger.log_info(f"🎯 ZMIANA ETAPU TERAPII: {old_stage} → {current_stage}")
```

#### **Krok 4: 🩺 Generowanie Odpowiedzi Terapeuty**
```python
# workflow/therapist_responder.py
def generate_response():
    # 1. Pobieranie system prompt dla terapeuty
    system_prompt = prompt_manager.get_system_prompt("therapist")
    therapist_agent.set_system_prompt(system_prompt)  # RAZ NA SESJĘ

    # 2. Pobieranie stage prompt dla aktualnego etapu
    stage_prompt = prompt_manager.get_stage_prompt(current_stage, "therapist")

    # 3. Generowanie odpowiedzi z stage prompt
    response = therapist_agent.generate_response(
        user_message=user_message,
        stage_prompt=stage_prompt,
        conversation_history=conversation_history,
        stage_id=current_stage
    )

    return WorkflowResult(success=True, message=response["response"])
```

#### **Krok 5: 🧠 BaseAgent - Smart Memory Management**
```python
# agents/base.py
class BaseAgent:
    def _generate_with_memory_optimization(self, prompt, system_prompt=None):
        # Sprawdzenie możliwości provider'a
        supports_memory = self._supports_memory()

        if supports_memory:
            # ULTRA-OPTIMIZED: system prompt już ustawiony
            response = self.llm_provider.generate_sync(prompt=prompt)
            strategy = "ultra_optimized"
        else:
            # TRADITIONAL: dołącz system prompt do każdej wiadomości
            full_prompt = f"SYSTEM: {system_prompt}\n\nUSER: {prompt}"
            response = self.llm_provider.generate_sync(prompt=full_prompt)
            strategy = "traditional"

        # LOG: Strategia i pełny prompt
        self._prepare_prompt_info(strategy, prompt_content, review)
        return response
```

#### **Krok 6: 💬 LLM Provider - Conversation Memory**
```python
# llm/openai_provider.py, gemini_provider.py
class OpenAIProvider(LLMProvider):
    def generate_sync(self, prompt: str, **kwargs):
        # Przygotowanie wiadomości z conversation memory
        messages = self._prepare_messages(prompt, system_prompt=None)

        # API call z historią konwersacji
        response = self.client.chat.completions.create(
            model=self.model_name,
            messages=messages,  # Lista: [{"role": "system"}, {"role": "user"}, ...]
            temperature=kwargs.get("temperature", 0.7),
            max_tokens=kwargs.get("max_tokens", 150)
        )

        # Dodanie odpowiedzi do conversation memory
        self.add_assistant_message(response_text)
        return response_text
```

#### **Krok 7: 📝 Logowanie Szczegółowe**
```python
# core/technical_logger.py
def log_therapist_request(prompt_data):
    self.add_log_entry("therapist_request",
        f"📝 System prompt set: {system_prompt_set}\n"
        f"📝 Stage prompt ({stage_id}): {stage_prompt[:100]}...\n"
        f"📝 User context: {user_message}")

def log_therapist_response(response, response_time):
    self.add_log_entry("therapist_response", response, response_time)

# BaseAgent loguje strategię prompt'ów
def _prepare_prompt_info(self, strategy, content, review):
    self._last_used_prompt_info = {
        "strategy": strategy,  # ultra_optimized/memory_optimized/traditional
        "full_prompt": content,
        "review": f"{strategy} approach - {review}"
    }
```

### **🎛️ Strategie Prompt'ów w Praktyce:**

#### **🚀 Ultra-Optimized (najlepsza - modele z pamięcią)**
```
1. System prompt → set_system_prompt() RAZ na sesję
2. Stage prompt → set_stage_prompt() RAZ na etap (jako conversation message)
3. User prompt → tylko kontekst + user message

LOG: "Ultra-optimized: system+stage w pamięci, tylko 50 tokenów wysłanych"
```

#### **💾 Memory-Optimized (fallback dla modeli z pamięcią)**
```
1. System prompt → set_system_prompt() RAZ na sesję
2. Stage prompt → dołączany do każdej wiadomości
3. User prompt → stage + kontekst + user message

LOG: "Memory-optimized: system w pamięci, stage+context per message"
```

#### **📝 Traditional (modele bez pamięci)**
```
1. System prompt → dołączany do każdej wiadomości
2. Stage prompt → dołączany do każdej wiadomości
3. User prompt → system + stage + kontekst + user message

LOG: "Traditional: wszystkie prompty per message, 500+ tokenów"
```

### **🔄 Cykl życia Stage Prompt'ów:**

```python
# Przy zmianie etapu:
1. supervisor_evaluator.py: decision="advance"
2. session_manager: advance_stage()
3. therapist_responder.py: get_stage_prompt(new_stage)
4. therapist_agent: set_stage_prompt(new_stage, prompt)
5. LLM Provider: add_user_message(stage_instruction)
6. LLM Provider: add_assistant_message("Rozumiem nowy etap")

# LOG w każdym kroku:
"🎯 SUPERVISOR: przejście opening → resources"
"📝 STAGE PROMPT SET: resources stage dla therapist"
"🧠 MEMORY: stage prompt dodany do conversation history"
```

### **⚙️ Parametry per Agent:**

```python
# config/json/app_config.json (aktualna struktura - do zmiany)
{
  "parameters": {
    "temperature": 0.7,    // ❌ dla wszystkich
    "max_tokens": 150      // ❌ dla wszystkich
  }
}

# Docelowa struktura:
{
  "agents": {
    "therapist": {
      "provider": "openai",
      "model": "gpt-4o",
      "parameters": {
        "temperature": 0.7,    // ✅ tylko dla terapeuty
        "max_tokens": 200,     // ✅ dłuższe odpowiedzi
        "top_p": 0.9
      }
    },
    "supervisor": {
      "provider": "gemini",
      "model": "gemini-1.5-flash",
      "parameters": {
        "temperature": 0.3,    // ✅ mniej kreatywności
        "max_tokens": 300,     // ✅ dłuższa analiza
        "top_p": 0.8
      }
    }
  }
}
```

### 🚨 **Bezpieczeństwo**
- **Automatyczna detekcja** sytuacji kryzysowych
- **Protokół kryzysowy** z numerami pomocy
- **Monitorowanie bezpieczeństwa** w czasie rzeczywistym

### 🤖 **Obsługa Modeli AI**
- **🌐 OpenAI**: GPT-4o, GPT-4o-mini, GPT-4, GPT-3.5-turbo
- **🧠 Google Gemini**: gemini-1.5-flash, gemini-1.5-pro, gemini-pro
- **🔍 Automatyczne wykrywanie** dostępnych modeli
- **💾 Inteligentny cache** z odświeżaniem co 7 dni

### 🧪 **Testowanie Modeli**
- **💬 Tryb czatu**: Proste testowanie konwersacji
- **🧠 Test pamięci**: Zaawansowane sprawdzanie zdolności modelu
- **📊 Analiza wyników**: Automatyczne rekomendacje konfiguracji

### 🔧 **Zaawansowane Logowanie**
- **📝 Szczegółowe logi** wszystkich interakcji
- **📋 Kopiowanie bloków** według rozmów użytkownika
- **🎯 Śledzenie etapów** w czasie rzeczywistym
- **🔍 Podgląd promptów** w rozwijaných kontenerach

## 🚀 Instalacja

### Wymagania
- **Python 3.12+**
- **4GB RAM** (dla modeli chmurowych)
- **Klucze API** OpenAI lub Google Gemini

### Kroki instalacji

```bash
# 1. Pobierz aplikację
git clone https://github.com/your-username/psychia.git
cd psychia

# 2. Utwórz środowisko wirtualne
python -m venv venv
source venv/bin/activate  # Linux/Mac
# venv\Scripts\activate   # Windows

# 3. Zainstaluj wymagania
pip install -r requirements.txt

# 4. Uruchom aplikację
streamlit run app.py
```

## ⚙️ Konfiguracja

### Klucze API - plik `.env`

Utwórz plik `.env` w katalogu głównym:

```bash
# OpenAI (zalecane)
OPENAI_API_KEY=sk-your-openai-api-key-here

# Google Gemini (alternatywa)
GOOGLE_API_KEY=your-google-api-key-here
```

**Gdzie uzyskać klucze:**
- **OpenAI**: [platform.openai.com/api-keys](https://platform.openai.com/api-keys)
- **Google Gemini**: [makersuite.google.com/app/apikey](https://makersuite.google.com/app/apikey)

### Konfiguracja w aplikacji

Wszystkie pozostałe ustawienia można zmienić w interfejsie aplikacji:
- **Wybór modeli** dla terapeuty i supervisora
- **Parametry generowania** (temperatura, max tokens)
- **Ustawienia bezpieczeństwa**
- **Opcje logowania**

## 💻 Użycie

### Szybki start

1. **Uruchom aplikację**:
   ```bash
   streamlit run app.py
   ```

2. **Wprowadź klucze API** w pasku bocznym

3. **Wybierz modele** dla terapeuty i supervisora

4. **Rozpocznij rozmowę** - napisz pierwszą wiadomość!

### Interfejs aplikacji

#### **💬 Główne okno**
- **Czat**: Rozmowa z terapeutą AI
- **Informacja o etapie**: Aktualny etap terapii
- **Kontrola etapów**: Możliwość ręcznej zmiany etapu

#### **🔧 Logi techniczne**
- **Kopiowanie bloków**: Każdą rozmowę można skopiować
- **Rozwijane szczegóły**: Pełne prompty i odpowiedzi
- **Kolorowe oznaczenia**: Różne typy wiadomości
- **Historia bez limitów**: Wszystkie rozmowy są zapisywane

#### **⚙️ Pasek boczny**
- **Klucze API**: Wprowadzanie i weryfikacja
- **Wybór modeli**: Dynamiczna lista dostępnych modeli
- **Parametry**: Temperatura, długość odpowiedzi
- **Status**: Informacje o połączeniu z modelami

## 🤖 Modele AI

### Zalecane konfiguracje

#### **🏆 Konfiguracja Idealna**
- **Terapeuta**: `gpt-4o`
- **Supervisor**: `gpt-4o-mini`
- **Koszt**: ~$0.01-0.05 za sesję
- **Jakość**: Najwyższa

#### **⚡ Konfiguracja Ekonomiczna**
- **Terapeuta**: `gpt-4o-mini`
- **Supervisor**: `gpt-4o-mini`
- **Koszt**: ~$0.001-0.01 za sesję
- **Jakość**: Bardzo dobra

#### **🧠 Konfiguracja Gemini**
- **Terapeuta**: `gemini-1.5-pro`
- **Supervisor**: `gemini-1.5-flash`
- **Koszt**: ~$0.001-0.02 za sesję
- **Jakość**: Dobra alternatywa

### Status modeli w aplikacji
- ✅ **Dostępny**: Model gotowy do użycia
- ⚠️ **Wymaga klucza**: Wprowadź klucz API
- ❌ **Niedostępny**: Model nie jest obsługiwany

## 🧪 Testowanie modeli

### Test pamięci modelu

Aplikacja zawiera zaawansowany system testowania:

#### **🔬 5-stopniowy test**
1. **🔧 System Prompt**: Ustawienie podstawowych instrukcji
2. **🎯 Stage Prompt**: Ustawienie instrukcji dla etapu
3. **💬 Wiadomość testowa**: "Cześć jestem Kacper"
4. **🔍 Test pamięci**: Sprawdzenie czy model pamięta rozmowę
5. **🎯 Test świadomości**: Czy model wie w jakim jest etapie

#### **📊 Automatyczna analiza**
- **Obsługa pamięci**: Czy model zachowuje kontekst
- **Jakość odpowiedzi**: Ocena poprawności reakcji
- **Czas odpowiedzi**: Pomiar wydajności
- **Rekomendacje**: Sugestie optymalnej konfiguracji

#### **🎯 Przykład testu**
```
System: "Jesteś profesjonalnym terapeutą TSR..."
Etap: "ETAP 1: OTWARCIE - ciepłe powitanie klienta"
Wiadomość: "Cześć jestem Kacper"
→ Odpowiedź modelu
Test pamięci: "Pokaż naszą historię rozmowy"
Test etapu: "W którym etapie terapii się znajdujemy?"
```

### Jak interpretować wyniki
- **Model z pamięcią**: Lepszy dla dłuższych sesji, niższe koszty
- **Model bez pamięci**: Wymaga więcej konfiguracji, wyższe koszty
- **Szybkie odpowiedzi**: Lepsze doświadczenie użytkownika
- **Świadomość etapu**: Ważne dla jakości terapii

## 🔧 Pliki konfiguracyjne

### Struktura konfiguracji

```
psychia/
├── .env                          # Klucze API (utwórz samodzielnie)
├── config.py                     # Główna konfiguracja Python
├── config/json/
│   ├── app_config.json          # Ustawienia aplikacji
│   └── stages/
│       └── stages.json          # Definicje etapów terapii
├── prompts/
│   ├── system/                  # Prompty systemowe
│   │   ├── therapist.yaml
│   │   └── supervisor.yaml
│   └── stages/                  # Prompty dla etapów
│       ├── therapist/           # Prompty terapeuty per etap
│       └── supervisor/          # Prompty supervisora per etap
```

### Co znajduje się w każdym pliku

#### **`.env` - Klucze API**
```bash
OPENAI_API_KEY=sk-...
GOOGLE_API_KEY=AI...
```

#### **`config/json/app_config.json` - Ustawienia aplikacji**
- Domyślne modele dla terapeuty i supervisora
- Parametry generowania (temperatura, max tokens)
- Ustawienia bezpieczeństwa
- Opcje interfejsu

#### **`config/json/stages/stages.json` - Etapy terapii**
- Definicje 5 etapów TSR
- Nazwy, opisy, kolejność
- Szacowany czas trwania każdego etapu

#### **`prompts/system/` - Prompty podstawowe**
- `therapist.yaml`: Podstawowe instrukcje dla terapeuty
- `supervisor.yaml`: Instrukcje dla supervisora

#### **`prompts/stages/` - Prompty dla etapów**
- `therapist/opening.json`: Instrukcje terapeuty dla etapu otwarcia
- `supervisor/opening.json`: Kryteria supervisora dla etapu otwarcia
- *(analogicznie dla pozostałych etapów)*

### Jak modyfikować konfigurację

1. **Zmiana modeli**: Użyj interfejsu aplikacji (pasek boczny)
2. **Zmiana parametrów**: Slider'y w aplikacji
3. **Zmiana promptów**: Edytuj pliki w `prompts/`
4. **Zmiana etapów**: Edytuj `config/json/stages/stages.json`
5. **Nowe klucze API**: Edytuj plik `.env`

---

**🧠 Psychia - Twój inteligentny asystent terapeutyczny**

*Łączy najlepsze praktyki terapii TSR z możliwościami nowoczesnej sztucznej inteligencji*